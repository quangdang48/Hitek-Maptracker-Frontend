<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leaflet Fullscreen Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <form id="filterForm" style="position: absolute; z-index: 1500; margin-left: 50px; margin-top: 10px ; background: #fff; padding: 10px; border-radius: 8px;">
    <!-- Thiết bị -->
    <label for="deviceId">Thiết bị:</label>
    <select id="deviceId">
    </select>
    <!-- Ngày -->
    <label for="date">Ngày:</label>
    <input type="date" id="date" value="">
    <!-- type -->
    <label for="type">Loại: </label>
    <select id="type">
    </select>
    <button type="submit">Xem</button>
  </form>
  <!-- Map -->
  <div id="map"></div>
  <script>
    // Khởi tạo danh sách thiết bị
    const getDeviceList = () => {
      axios.get('http://localhost:5263/api/devices')
        .then(function(response) {
          const deviceSelect = document.getElementById('deviceId');
          response.data.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceID;
            option.textContent = device.name;
            deviceSelect.appendChild(option);
          });
        })
        .catch(function(error) {
          console.log(error);
        });
    };
    // Khởi tạo map chỉ 1 lần khi trang load
    let map = L.map('map').setView([21.0285, 105.8542], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);
    let markers = [];
    let group = null;


    const loadMap = (deviceId, date) => {
      let url = `http://localhost:5263/api/location?deviceId=${deviceId}&date=${date}`;
      axios.get(url)
        .then(function(response) {
          const types = [...new Set(response.data.map(item => item.type))];
          const data = response.data;
          const points = data.map(item => [item.latitude, item.longitude, item.title, item.linkInfo, item.type]);
          console.log(typeof(points));
          fillType(types);
          viewMapByPoint(points);
          // // add listeners for type change
          document.getElementById('type').addEventListener('change', (e) => {
            const selectedType = e.target.value;
            if( selectedType == 0) {
              viewMapByPoint(points);
              return;
            }
            const filteredPoints = data
              .filter(item => item.type == selectedType)
              .map(item => [item.latitude, item.longitude, item.title, item.linkInfo, item.type]);
            viewMapByPoint(filteredPoints);
          });
        })
        .catch(function(error) {
          console.log(error);
        });
    };
    const fillType = (types) => {
      const typeSelect = document.getElementById('type');
      typeSelect.innerHTML = ""; // Xóa các tùy chọn cũ
      types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
      });

      //append default option
      const defaultOption = document.createElement('option');
      defaultOption.value = 0;
      defaultOption.textContent = 'Tất cả';
      typeSelect.appendChild(defaultOption);
    };



    const viewMapByPoint = (points) => {
      // Xóa marker và group cũ nếu có
      console.log(points.length);
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
      if (group) {
        map.removeLayer(group);
        group = null;
      }
      if (points.length === 0) {
        alert('Không có dữ liệu!');
        return;
      }
      // Thêm marker mới
      points.forEach((point, idx) => {
        let coordinate = [point[0], point[1]];
        let title = point[2] || 'Không có tiêu đề';
        let linkInfo = point[3] || '';
        let type = point[4] || 'Không có loại';
        let marker;
        // Marker hình tròn nhỏ cho các điểm trung gian
        marker = L.circle(coordinate, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 25
        }).addTo(map);

        
        marker.bindPopup(title+
          `<br><a href="${linkInfo}" target="_blank">Xem chi tiết</a>`);
        markers.push(marker);
      });
      // Fit map theo các điểm
      group = new L.featureGroup(markers);
      map.fitBounds(group.getBounds());
    };

    document.getElementById('filterForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const deviceId = document.getElementById('deviceId').value;
      const date = document.getElementById('date').value;
      loadMap(deviceId, date);
    });
    getDeviceList();
  </script>
</body>
</html>
